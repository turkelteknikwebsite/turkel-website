---
import BaseLayout from '../layouts/BaseLayout.astro';
import projectsData from '../data/projects.json';

// Proje verilerini hazırla ve sırala
// 1. Yıla göre sırala (en yeni → en eski)
// 2. Aynı yıldaki projeleri alfabetik sırala (A → Z)
const projects = projectsData.projects.sort((a, b) => {
  // Tarihleri sayıya çevir (örn: "2023" → 2023)
  const yearA = parseInt(a.date);
  const yearB = parseInt(b.date);
  
  // Önce yıla göre sırala (büyükten küçüğe - en yeni en üstte)
  if (yearA !== yearB) {
    return yearB - yearA;
  }
  
  // Aynı yılsa, başlığa göre alfabetik sırala (A-Z)
  return a.title.localeCompare(b.title, 'tr', { sensitivity: 'base' });
});

const categories = projectsData.categories;
---

<BaseLayout 
  title="Projelerimiz - Türkel Global Stands"
  description="Gerçekleştirdiğimiz fuar standı projeleri. Mebel 2022, İtm Türkiye 2022, Middle East Energy 2023 ve daha fazlası."
>
  <!-- Page Header -->
  <section class="py-16 bg-navy text-white">
    <div class="container">
      <div class="max-w-4xl mx-auto text-center">
        <h1 class="text-h4 font-hanken font-medium mb-4">
          Projelerimiz
        </h1>
        <p class="text-body text-white/80 text-lg leading-relaxed">
          Gerçekleştirdiğimiz başarılı fuar standı projelerimizi keşfedin. 
          Her proje, mükemmellik arayışımızın ve yaratıcılığımızın bir yansımasıdır.
        </p>
      </div>
    </div>
  </section>

  <!-- Projects Grid -->
  <section class="py-section-lg">
    <div class="container">
      <div class="max-w-7xl mx-auto">
        <!-- Search Bar -->
        <div class="max-w-md mx-auto mb-8 animate-on-scroll px-4 md:px-0">
          <div class="relative">
            <input 
              type="text" 
              id="search-input" 
              placeholder="Proje ara... (fuar adı, şirket, lokasyon)" 
              class="w-full px-4 py-3 pl-12 text-body border border-grey/30 rounded-lg focus:outline-none focus:border-orange focus:ring-2 focus:ring-orange/20 transition-all"
            />
            <div class="absolute left-4 top-1/2 transform -translate-y-1/2">
              <svg class="w-5 h-5 text-grey" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
            </div>
            <button id="clear-search" class="absolute right-3 top-1/2 transform -translate-y-1/2 w-6 h-6 text-grey hover:text-orange transition-colors hidden">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Category Filter Buttons -->
        <div class="flex flex-wrap justify-center gap-2 md:gap-4 mb-8 md:mb-12 animate-on-scroll px-4 md:px-0">
          <button class="filter-btn active" data-category="all">
            Tüm Projeler
          </button>
          <button class="filter-btn" data-category="grup-katilim">
            Grup Katılım Stantlar
          </button>
          <button class="filter-btn" data-category="milli-katilim">
            Milli Katılım Stantlar
          </button>
          <button class="filter-btn" data-category="stand-tasarimlari">
            Stand Tasarımları
          </button>
          <button class="filter-btn" data-category="mobilya">
            Mobilya
          </button>
          <button class="filter-btn" data-category="teknoloji">
            Teknoloji
          </button>
          <button class="filter-btn" data-category="enerji">
            Enerji
          </button>
          <button class="filter-btn" data-category="tekstil">
            Tekstil
          </button>
          <button class="filter-btn" data-category="otomotiv">
            Otomotiv
          </button>
          <button class="filter-btn" data-category="other">
            Diğer
          </button>
        </div>

        <!-- Results Info -->
        <div class="text-center mb-6 px-4 md:px-0">
          <p id="results-info" class="text-body text-grey">
            <span id="results-count">0</span> proje gösteriliyor
          </p>
        </div>

        <!-- Projects Grid Container -->
        <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 lg:gap-8 px-4 md:px-0">
          <!-- Projects will be loaded here -->
        </div>

        <!-- No results message will be shown in grid when needed -->
      </div>
    </div>
  </section>

  <!-- Projects JavaScript -->
  <script is:inline define:vars={{ projects }}>
    console.log('🔥 JavaScript yüklendi!');
    
    document.addEventListener('DOMContentLoaded', function() {
        console.log('✅ DOM yüklendi');
        console.log('✅ Proje sayısı:', projects.length);
        
        const grid = document.getElementById('projects-grid');
        const searchInput = document.getElementById('search-input');
        const clearSearchBtn = document.getElementById('clear-search');
        const resultsCount = document.getElementById('results-count');
        const filterBtns = document.querySelectorAll('.filter-btn');
        
        let filteredProjects = [...projects];
        let currentCategory = 'all';
        let currentSearchTerm = '';
        
        if (grid) {
          console.log('✅ Grid bulundu');
        
        // Proje kartı oluşturma fonksiyonu
        function createProjectCard(project, originalIndex) {
          return `
            <div onclick="openModal(${originalIndex})" class="project-card" style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 24px; cursor: pointer; transition: transform 0.3s ease-out;">
              <div style="position: relative; overflow: hidden; border-radius: 8px 8px 0 0;">
                <img 
                  src="${project.mainImage}" 
                  alt="${project.title}" 
                  loading="lazy"
                  style="width: 100%; height: 200px; object-fit: cover; background: #f3f4f6;"
                  onerror="this.style.background='#f3f4f6'; this.style.display='flex'; this.style.alignItems='center'; this.style.justifyContent='center'; this.innerHTML='Görsel Yok';"
                />
                <div style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                  ${getCategoryDisplayName(project.category)}
                </div>
              </div>
              <div style="padding: 16px;">
                <h3 style="font-size: 18px; font-weight: 600; color: #000; margin-bottom: 8px; line-height: 1.3;">${project.title}</h3>
                <div style="display: flex; flex-direction: column; gap: 4px; color: #6b7280; margin-bottom: 8px; font-size: 14px;">
                  ${project.fairName ? `<span><i class="fas fa-calendar"></i> ${project.fairName}</span>` : ''}
                  ${project.company ? `<span><i class="fas fa-building"></i> ${project.company}</span>` : ''}
                  ${project.location ? `<span><i class="fas fa-map-marker-alt"></i> ${project.location}</span>` : ''}
                  <span><i class="fas fa-clock"></i> ${project.date}</span>
                </div>
                <p style="color: #6b7280; margin: 0; font-size: 14px; font-weight: 500;">${project.type}</p>
              </div>
            </div>
          `;
        }

        // Kategori görünen adını döndür
        function getCategoryDisplayName(category) {
          const categoryMap = {
            'grup-katilim': 'Grup Katılım',
            'milli-katilim': 'Milli Katılım', 
            'stand-tasarimlari': 'Stand Tasarımı',
            'mobilya': 'Mobilya',
            'teknoloji': 'Teknoloji',
            'enerji': 'Enerji',
            'tekstil': 'Tekstil',
            'otomotiv': 'Otomotiv',
            'Elektrik': 'Elektrik',
            'Ev Tekstil': 'Ev Tekstil',
            'Makine': 'Makine',
            'Gıda': 'Gıda',
            'Sağlık': 'Sağlık',
            'İnşaat': 'İnşaat'
          };
          return categoryMap[category] || category || 'Diğer';
        }

        // Projeleri filtrele
        function filterProjects() {
          filteredProjects = projects.filter(project => {
            // Kategori filtresi
            let categoryMatch = true;
            if (currentCategory !== 'all') {
              if (currentCategory === 'other') {
                // Diğer kategorisi - tanımlı kategoriler dışındakiler
                const definedCategories = ['grup-katilim', 'milli-katilim', 'stand-tasarimlari', 'mobilya', 'teknoloji', 'enerji', 'tekstil', 'otomotiv'];
                categoryMatch = !definedCategories.includes(project.category?.toLowerCase());
              } else {
                categoryMatch = project.category?.toLowerCase() === currentCategory.toLowerCase() ||
                               project.category === currentCategory;
              }
            }

            // Arama filtresi
            let searchMatch = true;
            if (currentSearchTerm) {
              const searchFields = [
                project.title,
                project.fairName,
                project.company,
                project.location,
                project.type,
                getCategoryDisplayName(project.category)
              ].filter(Boolean).join(' ').toLowerCase();
              
              searchMatch = searchFields.includes(currentSearchTerm.toLowerCase());
            }

            return categoryMatch && searchMatch;
          });

          renderProjects();
        }

        // Projeleri render et
        function renderProjects() {
          if (filteredProjects.length === 0) {
            grid.innerHTML = `
              <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #6b7280;">
                <div style="font-size: 48px; margin-bottom: 16px;">🔍</div>
                <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 8px; color: #374151;">Proje bulunamadı</h3>
                <p style="margin: 0;">Arama kriterlerinizi değiştirip tekrar deneyin.</p>
              </div>
            `;
          } else {
            const projectCards = filteredProjects.map(project => {
              const originalIndex = projects.findIndex(p => p.id === project.id);
              return createProjectCard(project, originalIndex);
            }).join('');
            
            grid.innerHTML = projectCards;
          }

          // Sonuç sayısını güncelle
          resultsCount.textContent = filteredProjects.length;
          console.log(`✅ ${filteredProjects.length} proje gösteriliyor`);
        }

        // İlk render
        renderProjects();

        // Event Listeners
        
        // Arama input'u
        searchInput.addEventListener('input', function(e) {
          currentSearchTerm = e.target.value.trim();
          
          // Clear button'u göster/gizle
          if (currentSearchTerm) {
            clearSearchBtn.classList.remove('hidden');
          } else {
            clearSearchBtn.classList.add('hidden');
          }
          
          filterProjects();
        });

        // Arama temizle butonu
        clearSearchBtn.addEventListener('click', function() {
          searchInput.value = '';
          currentSearchTerm = '';
          clearSearchBtn.classList.add('hidden');
          filterProjects();
          searchInput.focus();
        });

        // Kategori filter butonları
        filterBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            // Aktif butonu güncelle
            filterBtns.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            
            // Kategoriyi güncelle
            currentCategory = this.dataset.category;
            
            filterProjects();
          });
        });

        // Klavye kısayolları
        document.addEventListener('keydown', function(e) {
          // Ctrl/Cmd + K ile arama odakla
          if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            searchInput.focus();
            searchInput.select();
          }
          
          // ESC ile arama temizle
          if (e.key === 'Escape' && document.activeElement === searchInput) {
            if (currentSearchTerm) {
              searchInput.value = '';
              currentSearchTerm = '';
              clearSearchBtn.classList.add('hidden');
              filterProjects();
            } else {
              searchInput.blur();
            }
          }
        });
        
        // Modal HTML'ini sayfaya ekle (anasayfa ile aynı tasarım)
        const modalHTML = `
          <div id="project-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-2 md:p-4" onclick="closeModal()">
            <div class="bg-white rounded-lg max-w-5xl w-full h-[90vh] md:h-[75vh] flex flex-col md:flex-row overflow-hidden" onclick="event.stopPropagation()">
              <!-- Sidebar -->
              <div class="w-full md:w-64 bg-white p-4 md:p-6 flex-shrink-0 flex flex-col order-2 md:order-1 max-h-[40vh] md:max-h-none overflow-y-auto md:overflow-visible">
                <!-- Modal Header -->
                <div class="flex items-center justify-between mb-6">
                  <h2 id="modal-title" class="text-xl font-semibold text-black"></h2>
                  <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-grey/20 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                  </button>
                </div>
                
                <!-- Fair Details -->
                <div class="grid grid-cols-1 gap-4 mb-8">
                  <div>
                    <h4 class="text-sm font-semibold text-black mb-1">Fuar Adı</h4>
                    <p id="modal-fair-name" class="text-sm text-grey"></p>
                  </div>
                  <div>
                    <h4 class="text-sm font-semibold text-black mb-1">Lokasyon</h4>
                    <p id="modal-location" class="text-sm text-grey"></p>
                  </div>
                  <div>
                    <h4 class="text-sm font-semibold text-black mb-1">Tarih</h4>
                    <p id="modal-date" class="text-sm text-grey"></p>
                  </div>
                  <div>
                    <h4 class="text-sm font-semibold text-black mb-1">Şirket</h4>
                    <p id="modal-company" class="text-sm text-grey"></p>
                  </div>
                  <div>
                    <h4 class="text-sm font-semibold text-black mb-1">Stant Tipi</h4>
                    <p id="modal-type" class="text-sm text-grey"></p>
                  </div>
                </div>

                <!-- Contact Section -->
                <div class="mt-auto border-t border-grey/20 pt-6">
                  <h4 class="text-sm font-semibold text-black mb-3">Stant Tasarımı</h4>
                  <p class="text-xs text-grey mb-4 leading-relaxed">
                    İhtiyaçlarınızı konuşalım mı? Size özel stant tasarımları için bizimle iletişime geçin.
                  </p>
                  <a href="/iletisim" class="inline-flex items-center justify-center w-full px-4 py-2 text-sm font-medium text-white bg-orange rounded-lg hover:bg-navy transition-colors">
                    İletişime Geçin
                  </a>
                </div>
              </div>
              
              <!-- Image Slider Area -->
              <div class="flex-1 relative bg-black order-1 md:order-2 min-h-[50vh] md:min-h-0">
                <div class="absolute inset-0">
                  <div id="modal-slider" class="relative w-full h-full">
                    <!-- Images will be populated by JavaScript -->
                  </div>
                  
                  <!-- Slider Navigation -->
                  <button id="modal-prev" class="absolute left-2 md:left-4 top-1/2 transform -translate-y-1/2 w-8 h-8 md:w-10 md:h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition-colors z-10">
                    <svg class="w-4 h-4 md:w-5 md:h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                  </button>
                  <button id="modal-next" class="absolute right-2 md:right-4 top-1/2 transform -translate-y-1/2 w-8 h-8 md:w-10 md:h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition-colors z-10">
                    <svg class="w-4 h-4 md:w-5 md:h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                  </button>
                  
                  <!-- Image Counter -->
                  <div class="absolute bottom-2 md:bottom-4 left-1/2 transform -translate-x-1/2 bg-black/50 text-white px-2 md:px-3 py-1 rounded-full text-xs md:text-sm z-10">
                    <span id="modal-counter">1 / 3</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Modal'ı body'e ekle
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Modal değişkenleri
        let currentModalImage = 0;
        let currentProject = null;

        // Modal fonksiyonları
        window.openModal = function(projectIndex) {
          console.log('Modal açılıyor, proje:', projectIndex);
          
          const project = projects[projectIndex];
          currentProject = project;
          currentModalImage = 0;
          
          // Sidebar içeriğini güncelle
          document.getElementById('modal-title').textContent = project.title;
          document.getElementById('modal-fair-name').textContent = project.fairName;
          document.getElementById('modal-location').textContent = project.location;
          document.getElementById('modal-date').textContent = project.date;
          document.getElementById('modal-company').textContent = project.company;
          document.getElementById('modal-type').textContent = project.type;
          
          // Image slider'ı kur
          setupModalSlider();
          
          const modal = document.getElementById('project-modal');
          if (modal) {
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            console.log('✅ Modal açıldı, proje:', project.title);
          } else {
            console.error('❌ Modal bulunamadı');
          }
        }
        
        function setupModalSlider() {
          const slider = document.getElementById('modal-slider');
          const counter = document.getElementById('modal-counter');
          
          // Slider içeriğini temizle ve yeniden oluştur
          slider.innerHTML = '';
          
          currentProject.gallery.forEach((imageSrc, index) => {
            const imageDiv = document.createElement('div');
            imageDiv.className = 'absolute inset-0 transition-opacity duration-300';
            imageDiv.style.opacity = index === 0 ? '1' : '0';
            
            const img = document.createElement('img');
            img.src = imageSrc;
            img.alt = currentProject.title;
            img.loading = 'lazy';
            img.className = 'w-full h-full object-cover';
            img.style.background = '#f3f4f6';
            img.onerror = function() {
              this.style.background = '#f3f4f6';
              this.style.display = 'flex';
              this.style.alignItems = 'center';
              this.style.justifyContent = 'center';
              this.innerHTML = 'Görsel Yok';
            };
            
            imageDiv.appendChild(img);
            slider.appendChild(imageDiv);
          });
          
          // Counter'ı güncelle
          counter.textContent = `1 / ${currentProject.gallery.length}`;
          
          // Navigation event listeners
          document.getElementById('modal-prev').onclick = () => changeModalImage(-1);
          document.getElementById('modal-next').onclick = () => changeModalImage(1);
        }
        
        function changeModalImage(direction) {
          const images = document.querySelectorAll('#modal-slider > div');
          const counter = document.getElementById('modal-counter');
          
          // Mevcut resmi gizle
          images[currentModalImage].style.opacity = '0';
          
          // Yeni index hesapla
          currentModalImage += direction;
          if (currentModalImage < 0) currentModalImage = images.length - 1;
          if (currentModalImage >= images.length) currentModalImage = 0;
          
          // Yeni resmi göster
          images[currentModalImage].style.opacity = '1';
          
          // Counter'ı güncelle
          counter.textContent = `${currentModalImage + 1} / ${images.length}`;
        }
        
        window.closeModal = function() {
          console.log('Modal kapatılıyor');
          const modal = document.getElementById('project-modal');
          if (modal) {
            modal.classList.add('hidden');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
          }
        }
        
        // ESC tuşu ile kapatma
        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            closeModal();
          }
        });
        
        console.log('✅ Projeler eklendi:', filteredProjects.length);
      } else {
        console.error('❌ Grid bulunamadı');
      }
    });
  </script>

  <!-- Styles for filter buttons and animations -->
  <style>
    .filter-btn {
      @apply px-6 py-3 text-body font-medium text-grey border border-grey/30 rounded-lg transition-all duration-300 hover:border-orange hover:text-orange;
    }
    
    .filter-btn.active {
      @apply bg-orange text-white border-orange;
    }
    
    .animate-on-scroll {
      opacity: 0;
      transform: translateY(30px);
      transition: all 0.6s ease-out;
    }
    
    .animate-on-scroll.is-visible {
      opacity: 1;
      transform: translateY(0);
    }
    
    .project-card {
      transition: transform 0.3s ease-out;
    }
    
    .project-card:hover {
      transform: translateY(-5px);
    }
  </style>
</BaseLayout>